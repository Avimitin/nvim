name: MacOS Test

on:
  push:
    branches:
    - master
    paths:
      - "lua/**"
      - "init.lua"
      - ".github/workflows/test_macos.yml"

jobs:
  container-job:
    runs-on: macos-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Install Deps
      run: |
        NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        brew install jq ripgrep
    - name: Install Neovim
      run: |
        curl -LO https://github.com/neovim/neovim/releases/download/nightly/nvim-macos.tar.gz
        tar xzf nvim-macos.tar.gz
    - name: Test
      run: |
        INSTALL_LOG_FILE=$(mktemp)
        ./nvim-macos/bin/nvim --headless -c "au User PackerComplete quitall" &> $INSTALL_LOG_FILE
        if rg -qS "err" $INSTALL_LOG_FILE; then cat $INSTALL_LOG_FILE && false; fi
    - name: Test snippets files
      run: cd $HOME/.config/nvim && ./scripts/validate-snippets.sh
